(()=>{"use strict";const e={},t=function(t,s){e[t]=e[t]||[],e[t].forEach((e=>e.apply(null,s)))};class s{constructor(e){this.element=e,this.init()}init(){const{validate:e}=this.element.dataset;e?(this.enableJsValidation(),this.element.addEventListener("bouncerFormValid",this.handleSubmit.bind(this),!1)):this.element.addEventListener("submit",this.handleSubmit.bind(this),!0),this.isRtfEnabled(),this.addFlatpickr()}handleSubmit(e){console.log(e),e.preventDefault(),e.stopPropagation(),this.showLoading();const{captcha:t,noajax:s}=this.element.dataset;s?this.submitNoAjax():t?this.submitWithCaptcha(t):this.submitForm()}submitNoAjax(){this.element.submit()}submitWithCaptcha(e){if("reCaptcha"===e){const e=this.element.querySelector(".g-recaptcha"),{size:t}=e.dataset;"invisible"===t?window.grecaptcha.execute().then((()=>this.submitForm())):this.submitForm()}else window.hcaptcha.execute().then((()=>this.submitForm()))}async submitForm(){this.cleanMessage(),this.emitEvent("submit");const e=new FormData(this.element);try{const t=await fetch(window.formello.ajax_url,{method:"POST",body:e}),s=await t.json();this.showLoading(),this.response(s)}catch(e){this.addMessage({data:{message:e}})}}response(e){this.emitEvent("submitted",this.element),e.success?this.emitEvent("success",this.element):this.emitEvent("error",this.element);const{data:t}=e;if(t.redirect_url&&e.success)return window.location=t.redirect_url,!1;t.message&&(this.addMessage(e),this.emitEvent("message",this.element)),t.hide&&e.success&&(this.element.style.display="none"),t.debug&&(this.addDebug(t.debug),console.log(t.debug)),e.success&&this.element.reset()}addMessage(e){const t=this.element.querySelector(".formello-message"),s=e.success?"success":"error";t.classList.add(s);const{data:n}=e;if(t.innerHTML="<p>"+n.message+"</p>",n.errors?.length){const e=document.createElement("ul");t.appendChild(e),n.errors.forEach((function(t){const s=document.createElement("li");e.appendChild(s),s.innerHTML+=t}))}n.hide&&e.success&&this.element.insertAdjacentElement("afterend",t)}addDebug(e){const t=this.element.querySelector(".formello-message"),s=document.createElement("div");s.classList.add("formello-debug"),s.innerHTML="<p>Debug output:</p>",s.innerHTML+="<small>This output is visible only to admin.</small>",s.innerHTML+="<pre>"+JSON.stringify(e,void 0,2)+"</pre>",t.insertAdjacentElement("afterend",s)}cleanMessage(){const e=this.element.querySelector(".formello-message");e.innerHTML="",e.setAttribute("class","formello-message"),e.nextSibling&&"formello-debug"===e.nextSibling.className&&e.nextSibling.remove()}showLoading(){const e=this.element.querySelector(".wp-block-formello-button");e.classList.toggle("wp-block-formello-button--loading"),e.toggleAttribute("disabled")}emitEvent(e){window.dispatchEvent(new CustomEvent("formello-"+e)),this.element.dispatchEvent(new CustomEvent("formello-"+e)),t(e,[this.element])}enableJsValidation(){const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/gh/cferdinandi/bouncer@1.4.6/dist/bouncer.min.js";const{id:t}=this.element.dataset;e.onload=function(){new window.Bouncer(`.wp-block-formello-form[data-id='${t}']`,{disableSubmit:!0,customValidations:{valueMismatch(e){const t=e.getAttribute("data-bouncer-match");if(!t)return!1;const s=e.form.querySelector("[name="+t+"]");return!!s&&s.value!==e.value}},messageCustom:"data-bouncer-message",messages:{missingValue:window.formello.settings.messages.missingValue,patternMismatch:window.formello.settings.messages.patternMismatch,outOfRange:window.formello.settings.messages.outOfRange,wrongLength:window.formello.settings.messages.wrongLength,valueMismatch:e=>e.getAttribute("data-bouncer-mismatch-message")||"Please make sure the fields match."}})},document.head.appendChild(e)}isRtfEnabled(){if(this.element.querySelectorAll(".formello-rtf").length){const e=document.createElement("script");e.onload=function(){window.tinymce.init({selector:".formello-rtf",setup:e=>{e.on("change",(()=>{window.tinymce.triggerSave()}))},menubar:!1,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table paste code help wordcount"],toolbar:"formatselect | bold italic underline | bullist numlist  | alignleft aligncenter alignright alignjustify | link unlink | undo redo",content_style:"body { font-family:Helvetica,Arial,sans-serif; font-size:14px }"})},e.src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.10.3/tinymce.min.js",document.head.appendChild(e)}}addFlatpickr(){if(this.element.querySelectorAll("input.formello-advanced[type=date]").length){const e=document.createElement("script"),t=document.createElement("link");t.setAttribute("type","text/css"),t.setAttribute("href","https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"),t.setAttribute("rel","stylesheet"),e.onload=function(){window.flatpickr("input.formello-advanced[type=date]")},e.src="https://cdn.jsdelivr.net/npm/flatpickr",document.head.appendChild(e),document.head.appendChild(t)}}}document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelectorAll(".wp-block-formello-form");e.length&&e.forEach((e=>{new s(e)}))}))})();